<!DOCTYPE html> 
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grupo bolivar</title>
    <link rel="stylesheet" href="estilos.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>

<body>
    <!-- Navigation -->
    <nav class="navbar">
        <h1> Reto Grupo BolÃ­var</h1>
    </nav>

    <!-- Connection Status -->
    <div class="connection-status connecting" id="connectionStatus">
        ğŸ”„ Conectando...
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Header Section -->
        <div class="header-section">
            <!-- Week Progress -->
            <div class="week-progress">
                <h2>ğŸ“Š Progreso Semanal del Equipo</h2>
                <div class="progress-bar">
                    <div class="progress-fill" id="weekProgress"></div>
                </div>
                <div class="stats" style="display:flex;gap:1rem;">
                    <span id="completedTasks">0 tareas completadas</span>
                    <span id="totalTasks">0 tareas totales</span>
                </div>
            </div>

            <!-- Team Selector -->
            <div class="team-selector">
                <h3>ğŸ‘¥ Miembros del Equipo</h3>
                <div class="team-member active" data-member="Duvan"><span>ğŸ”µ</span><span>Duvan</span></div>
                <div class="team-member" data-member="Juanse"><span>ğŸŸ¢</span><span>Juanse</span></div>
                <div class="team-member" data-member="Isa"><span>ğŸŸ¡</span><span>Isa</span></div>
                <div class="team-member" data-member="Raul"><span>ğŸŸ </span><span>Raul</span></div>
            </div>
        </div>

        <!-- Calendar Grid -->
        <div class="calendar-grid" id="calendar">
            <!-- Calendar content will be generated dynamically -->
        </div>
    </div>

    <!-- Comments Section -->
    <div class="comments-section" id="commentsSection">
        <div class="comments-header">
            <h2 style="margin:0;font-size:1rem;">ğŸ“ Comentarios y Aportes de la Semana</h2>
            <button class="toggle-comments-btn" id="toggleCommentsBtn" title="Expandir/Contraer">
                <i class="fas fa-chevron-up" id="toggleIcon"></i>
            </button>
        </div>

        <div class="comments-panel" id="commentsPanel">
            <!-- Comment Form -->
            <div class="comment-form">
                <div class="form-group">
                    <input type="text" id="commentTitle" placeholder="TÃ­tulo del aporte..." class="comment-input">
                </div>
                <div class="form-group">
                    <textarea id="commentText" placeholder="Escribe tu comentario o aporte aquÃ­..." class="comment-textarea"></textarea>
                </div>
                <div class="form-actions" style="display:flex;gap:.5rem;align-items:center;justify-content:space-between">
                    <select id="commentCategory" class="comment-select" style="max-width:48%">
                        <option value="general">ğŸ’¬ General</option>
                        <option value="idea">ğŸ’¡ Ideas</option>
                        <option value="problema">âš ï¸ Problemas</option>
                        <option value="solucion">âœ… Soluciones</option>
                        <option value="mejora">ğŸ“ˆ Mejoras</option>
                    </select>
                    <button class="save-comment-btn" id="saveCommentBtn"><i class="fas fa-save"></i> Guardar</button>
                </div>
            </div>

            <!-- Comment Filters -->
            <div class="comments-filters" id="commentsFilters" style="margin-top:.8rem">
                <button class="filter-btn active" data-filter="all">Todos</button>
                <button class="filter-btn" data-filter="general">ğŸ’¬ General</button>
                <button class="filter-btn" data-filter="idea">ğŸ’¡ Ideas</button>
                <button class="filter-btn" data-filter="problema">âš ï¸ Problemas</button>
                <button class="filter-btn" data-filter="solucion">âœ… Soluciones</button>
                <button class="filter-btn" data-filter="mejora">ğŸ“ˆ Mejoras</button>
            </div>

            <!-- Comments List -->
            <div class="comments-list" id="commentsList" style="margin-top:.6rem">
                <!-- Comments will be generated dynamically -->
            </div>
        </div>
    </div>

    <!-- Firebase compat (igual a lo que ya usas en el calendario) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
    // =================================== //
    //            CONFIGURATION            //
    // =================================== //
    const FIREBASE_CONFIG = {
        apiKey: "AIzaSyBxsZq65HUIif9SYTIx6T0SlpNpZaFSpMQ",
        authDomain: "calendario-grupo-bolivar2.firebaseapp.com",
        projectId: "calendario-grupo-bolivar2",
        storageBucket: "calendario-grupo-bolivar2.firebasestorage.app",
        messagingSenderId: "727096053646",
        appId: "1:727096053646:web:3de772558a625a66b85edf"
    };

    const DAY_NAMES = ['Lunes','Martes','MiÃ©rcoles','Jueves','Viernes','SÃ¡bado','Domingo'];
    const CATEGORY_LABELS = {
        'general': 'ğŸ’¬ General',
        'idea': 'ğŸ’¡ Ideas',
        'problema': 'âš ï¸ Problemas',
        'solucion': 'âœ… Soluciones',
        'mejora': 'ğŸ“ˆ Mejoras'
    };

    // =================================== //
    //           GLOBAL VARIABLES          //
    // =================================== //
    let currentMember = 'Duvan';
    let calendarData = {};
    let commentsData = [];
    let currentFilter = 'all';
    let db = null;
    let isFirebaseEnabled = false;
    let commentsListener = null; // unsubscribe function for comments realtime

    // =================================== //
    //         UTILITY FUNCTIONS           //
    // =================================== //
    function getWeekDays(date){
        const week=[];
        const startOfWeek=new Date(date);
        const day=startOfWeek.getDay();
        const diff=startOfWeek.getDate() - day + (day === 0 ? -6 : 1);
        startOfWeek.setDate(diff);
        for(let i=0;i<7;i++){
            const currentDay=new Date(startOfWeek);
            currentDay.setDate(startOfWeek.getDate()+i);
            week.push(currentDay);
        }
        return week;
    }

    function getWeekKey(date){
        const week = getWeekDays(date);
        const start = week[0];
        const year = start.getFullYear();
        const month = String(start.getMonth()+1).padStart(2,'0');
        const day = String(start.getDate()).padStart(2,'0');
        return `${year}-${month}-${day}`;
    }

    function isFirebaseConfigured(){
        // simple check (si modificas este archivo con placeholders, ajusta)
        return FIREBASE_CONFIG && FIREBASE_CONFIG.apiKey && FIREBASE_CONFIG.projectId &&
               FIREBASE_CONFIG.apiKey !== "YOUR_API_KEY_HERE" && FIREBASE_CONFIG.projectId !== "your-project-id";
    }

    function updateConnectionStatus(status){
        const statusEl = document.getElementById('connectionStatus');
        statusEl.className = `connection-status ${status}`;
        const statusMessages = {
            connected: 'âœ… Conectado a Firebase',
            disconnected: 'ğŸ’¾ Modo Local',
            connecting: 'ğŸ”„ Conectando...'
        };
        statusEl.textContent = statusMessages[status] || statusMessages.connecting;
    }

    // =================================== //
    //         FIREBASE FUNCTIONS          //
    // =================================== //
    async function initFirebase(){
        if (!isFirebaseConfigured()) {
            console.warn('Firebase no configurado correctamente - usando modo local');
            initLocalMode();
            return;
        }

        try {
            // inicializa compat (igual a como lo usa tu calendario)
            firebase.initializeApp(FIREBASE_CONFIG);
            db = firebase.firestore();
            isFirebaseEnabled = true;
            updateConnectionStatus('connected');

            // carga calendario (que ya funciona en tu app)
            await loadFromFirebase();

            // configura listener de comentarios en tiempo real (subcolecciÃ³n)
            setupCommentsRealtime();
        } catch (error) {
            console.error('Error inicializando Firebase:', error);
            isFirebaseEnabled = false;
            updateConnectionStatus('disconnected');
            initLocalMode();
        }
    }

    // ---------- CALENDARIO ----------
    async function loadFromFirebase(){
        try{
            const weekKey = getWeekKey(new Date());
            const doc = await db.collection('calendar').doc(weekKey).get();
            calendarData = doc.exists ? (doc.data().days || {}) : {};
            if (!doc.exists) {
                initCalendarData();
                await db.collection('calendar').doc(weekKey).set({
                    days: calendarData,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
            }
            generateCalendar();
            setupCalendarListener(weekKey);
        }catch(err){
            console.error('Error cargando calendario desde Firebase:',err);
            initLocalMode();
        }
    }

    function setupCalendarListener(weekKey){
        try{
            db.collection('calendar').doc(weekKey).onSnapshot((doc)=>{
                if(doc.exists){
                    calendarData = doc.data().days || {};
                    generateCalendar();
                }
            });
        }catch(e){
            console.error('setupCalendarListener error',e);
        }
    }

    async function saveCalendarData(){
        const weekKey = getWeekKey(new Date());
        localStorage.setItem(`calendar-${weekKey}`, JSON.stringify(calendarData));
        if (isFirebaseEnabled && db){
            try{
                await db.collection('calendar').doc(weekKey).set({
                    days: calendarData,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
            }catch(e){
                console.error('Error guardando calendario en Firebase:',e);
            }
        }
    }

    // ---------- COMENTARIOS (subcolecciÃ³n por semana: comments/{weekKey}/items) ----------
    function setupCommentsRealtime(){
        if (!isFirebaseEnabled || !db) {
            console.warn('No hay Firebase para setupCommentsRealtime');
            loadCommentsFromLocal();
            return;
        }

        const weekKey = getWeekKey(new Date());

        // limpia listener anterior
        if (commentsListener) {
            try{ commentsListener(); } catch(e){ console.warn('error unsubscribing',e); }
            commentsListener = null;
        }

        const ref = db.collection('comments').doc(weekKey).collection('items');

        commentsListener = ref.onSnapshot((snap) => {
            const arr = [];
            snap.forEach(docSnap => {
                const data = docSnap.data() || {};
                // normalizar timestamp numÃ©rico para ordenar en cliente
                let tsNum = null;
                if (data.ts && typeof data.ts.toDate === 'function') {
                    tsNum = data.ts.toDate().getTime();
                } else if (data.timestamp) {
                    tsNum = data.timestamp;
                } else {
                    tsNum = Date.now();
                }

                arr.push({
                    id: docSnap.id,
                    title: data.title || '',
                    text: data.text || '',
                    category: data.category || 'general',
                    author: data.author || 'AnÃ³nimo',
                    date: data.date || new Date(tsNum).toISOString(),
                    timestamp: tsNum
                });
            });

            // ordenar por timestamp descendente
            arr.sort((a,b) => (b.timestamp || 0) - (a.timestamp || 0));
            commentsData = arr;

            // respaldo local (solo para lectura si se cae)
            try { localStorage.setItem(`comments-${weekKey}`, JSON.stringify(commentsData)); } catch(e){}

            generateComments();
            console.log('Comentarios sincronizados desde Firebase:', commentsData.length);
        }, (error) => {
            console.error('Error en listener de comentarios:', error);
            loadCommentsFromLocal();
        });
    }

    async function saveCommentToFirebase(comment){
        if (!isFirebaseEnabled || !db) throw new Error('Firebase no disponible');
        const weekKey = getWeekKey(new Date());
        try {
            await db.collection('comments').doc(weekKey).collection('items').add({
                ...comment,
                // servidor para orden estable, y timestamp cliente para orden inmediato
                ts: firebase.firestore.FieldValue.serverTimestamp(),
                timestamp: comment.timestamp || Date.now()
            });
            return true;
        } catch (error) {
            console.error('Error guardando comentario en Firebase:', error);
            throw error;
        }
    }

    async function deleteCommentFromFirebase(commentId){
        if (!isFirebaseEnabled || !db) throw new Error('Firebase no disponible');
        const weekKey = getWeekKey(new Date());
        try {
            await db.collection('comments').doc(weekKey).collection('items').doc(commentId).delete();
            return true;
        } catch (error) {
            console.error('Error eliminando comentario en Firebase:', error);
            throw error;
        }
    }

    // =================================== //
    //          LOCAL MODE FUNCTIONS       //
    // =================================== //
    function initLocalMode(){
        updateConnectionStatus('disconnected');
        loadFromLocal();
        loadCommentsFromLocal();
    }

    function loadFromLocal(){
        const weekKey = getWeekKey(new Date());
        const localData = localStorage.getItem(`calendar-${weekKey}`);
        if (localData){
            try { calendarData = JSON.parse(localData); } catch(e){ console.error('parse calendar local',e); initCalendarData(); }
        } else { initCalendarData(); }
        generateCalendar();
    }

    function loadCommentsFromLocal(){
        const weekKey = getWeekKey(new Date());
        const localComments = localStorage.getItem(`comments-${weekKey}`);
        if (localComments){
            try { commentsData = JSON.parse(localComments); } catch(e){ console.error('parse comments local',e); commentsData = []; }
        } else { commentsData = []; }
        generateComments();
    }

    // =================================== //
    //        DATA INITIALIZATION          //
    // =================================== //
    function initCalendarData(){
        const today = new Date();
        const currentWeek = getWeekDays(today);
        currentWeek.forEach(date=>{
            const dateKey = date.toDateString();
            if (!calendarData[dateKey]) calendarData[dateKey] = { objective:'', tasks:[], assignedTo: currentMember };
        });

        const exampleDate = currentWeek[0].toDateString();
        if (!calendarData[exampleDate].objective) {
            calendarData[exampleDate] = {
                objective: 'Completar anÃ¡lisis de mercado',
                tasks: [
                    { text: 'Investigar competidores', completed: false },
                    { text: 'Analizar tendencias', completed: true },
                    { text: 'Preparar informe', completed: false }
                ],
                assignedTo: 'Ana GarcÃ­a'
            };
        }
    }

    // =================================== //
    //         CALENDAR FUNCTIONS          //
    // =================================== //
    function generateCalendar(){
        const calendar = document.getElementById('calendar');
        const today = new Date();
        const weekDays = getWeekDays(today);
        calendar.innerHTML = '';

        // headers (nombres dÃ­as)
        DAY_NAMES.forEach(dayName => {
            const header = document.createElement('div');
            header.className = 'day-header';
            header.textContent = dayName;
            calendar.appendChild(header);
        });

        weekDays.forEach((date,index) => {
            const dateKey = date.toDateString();
            const dayData = calendarData[dateKey] || { objective:'', tasks:[], assignedTo: currentMember };
            const dayCard = createDayCard(date,dateKey,dayData,index);
            calendar.appendChild(dayCard);
        });

        updateWeekProgress();
    }

    function createDayCard(date,dateKey,dayData,index){
        const today = new Date();
        const isToday = date.toDateString() === today.toDateString();
        const isWeekend = index >= 5;
        const completedTasks = dayData.tasks.filter(t=>t.completed).length;
        const totalTasks = dayData.tasks.length;
        const progressPercent = totalTasks > 0 ? (completedTasks/totalTasks)*100 : 0;

        const dayCard = document.createElement('div');
        dayCard.className = `day-card ${isWeekend ? 'weekend' : ''} ${isToday ? 'today' : ''}`;
        dayCard.innerHTML = `
            <div class="day-number">${date.getDate()}</div>
            <input type="text" class="objective-input" placeholder="Objetivo del dÃ­a..."
                   value="${escapeHtml(dayData.objective)}" data-date="${dateKey}">
            <div class="checklist" id="checklist-${dateKey}">
                ${dayData.tasks.map((task,i)=>`
                    <div class="checklist-item">
                        <input type="checkbox" ${task.completed ? 'checked' : ''} data-date="${dateKey}" data-task-index="${i}">
                        <input type="text" value="${escapeHtml(task.text)}" data-date="${dateKey}" data-task-index="${i}" data-task-text="true">
                        <button class="delete-task-btn" data-date="${dateKey}" data-task-index="${i}">âŒ</button>
                    </div>
                `).join('')}
            </div>
            <div class="card-actions">
                <button class="add-task-btn" data-date="${dateKey}">+ Agregar Tarea</button>
                <button class="reset-day-btn" data-date="${dateKey}">ğŸ”„ Reiniciar</button>
            </div>
            <div class="day-progress">
                <div class="day-progress-bar"><div class="day-progress-fill" style="width:${progressPercent}%"></div></div>
                <div class="day-progress-text">${completedTasks}/${totalTasks} completadas</div>
            </div>
        `;
        return dayCard;
    }

    function updateWeekProgress(){
        const weekDays = getWeekDays(new Date());
        let totalTasks=0, completedTasks=0;
        weekDays.forEach(date=>{
            const dateKey = date.toDateString();
            const dayData = calendarData[dateKey];
            if (dayData && dayData.tasks){
                totalTasks += dayData.tasks.length;
                completedTasks += dayData.tasks.filter(t=>t.completed).length;
            }
        });
        const progressPercent = totalTasks > 0 ? (completedTasks/totalTasks)*100 : 0;
        document.getElementById('weekProgress').style.width = progressPercent + '%';
        document.getElementById('completedTasks').textContent = `${completedTasks} tareas completadas`;
        document.getElementById('totalTasks').textContent = `${totalTasks} tareas totales`;
    }

    // =================================== //
    //         CALENDAR ACTIONS            //
    // =================================== //
    function updateObjective(dateKey,value){
        if (!calendarData[dateKey]) calendarData[dateKey] = { objective:'', tasks:[], assignedTo:currentMember };
        calendarData[dateKey].objective = value;
        calendarData[dateKey].assignedTo = currentMember;
        saveCalendarData();
    }

    function addTask(dateKey){
        if (!calendarData[dateKey]) calendarData[dateKey] = { objective:'', tasks:[], assignedTo:currentMember };
        calendarData[dateKey].tasks.push({ text:'Nueva tarea', completed:false });
        saveCalendarData();
        generateCalendar();
    }

    function updateTask(dateKey,taskIndex,value){
        if (calendarData[dateKey] && calendarData[dateKey].tasks[taskIndex]){
            calendarData[dateKey].tasks[taskIndex].text = value;
            saveCalendarData();
        }
    }

    function toggleTask(dateKey,taskIndex){
        if (calendarData[dateKey] && calendarData[dateKey].tasks[taskIndex]){
            calendarData[dateKey].tasks[taskIndex].completed = !calendarData[dateKey].tasks[taskIndex].completed;
            saveCalendarData();
            generateCalendar();
        }
    }

    function deleteTask(dateKey,taskIndex){
        if (!calendarData[dateKey] || !calendarData[dateKey].tasks[taskIndex]) return;
        if (confirm("Â¿Seguro que quieres eliminar esta tarea?")){
            calendarData[dateKey].tasks.splice(taskIndex,1);
            saveCalendarData();
            generateCalendar();
        }
    }

    function resetDay(dateKey){
        if (confirm("Â¿Seguro que quieres reiniciar este dÃ­a? Se borrarÃ¡n todas las tareas.")){
            calendarData[dateKey] = { objective:'', tasks:[], assignedTo: currentMember };
            saveCalendarData();
            generateCalendar();
        }
    }

    function selectMember(member){
        currentMember = member;
        document.querySelectorAll('.team-member').forEach(el => el.classList.remove('active'));
        const el = document.querySelector(`[data-member="${member}"]`);
        if (el) el.classList.add('active');
    }

    // =================================== //
    //        COMMENTS FUNCTIONS           //
    // =================================== //
    function toggleCommentsPanel(){
        const section = document.getElementById('commentsSection');
        const icon = document.getElementById('toggleIcon');
        section.classList.toggle('expanded');
        if (section.classList.contains('expanded')) icon.className = 'fas fa-chevron-down';
        else icon.className = 'fas fa-chevron-up';
    }

    async function saveComment(){
        const title = document.getElementById('commentTitle').value.trim();
        const text = document.getElementById('commentText').value.trim();
        const category = document.getElementById('commentCategory').value || 'general';
        if (!title || !text){ alert('Por favor completa el tÃ­tulo y el comentario'); return; }

        const comment = {
            title, text, category,
            author: currentMember,
            date: new Date().toISOString(),
            timestamp: Date.now()
        };

        if (isFirebaseEnabled && db){
            try {
                await saveCommentToFirebase(comment);
                // No actualizamos localmente aquÃ­: el snapshot de Firestore actualizarÃ¡ la UI.
            } catch (error) {
                // fallback: guardar local temporario
                console.warn('Fallback local: guardando comentario en backup local', error);
                const weekKey = getWeekKey(new Date());
                const temp = { id: 'local-' + Date.now(), ...comment };
                commentsData.unshift(temp);
                try { localStorage.setItem(`comments-${weekKey}`, JSON.stringify(commentsData)); } catch(e){}
                generateComments();
            }
        } else {
            // modo local
            const weekKey = getWeekKey(new Date());
            const temp = { id: 'local-' + Date.now(), ...comment };
            commentsData.unshift(temp);
            try { localStorage.setItem(`comments-${weekKey}`, JSON.stringify(commentsData)); } catch(e){}
            generateComments();
        }

        clearCommentForm();
    }

    function clearCommentForm(){
        document.getElementById('commentTitle').value = '';
        document.getElementById('commentText').value = '';
        document.getElementById('commentCategory').value = 'general';
    }

    function generateComments(){
        const commentsList = document.getElementById('commentsList');
        const filtered = currentFilter === 'all' ? commentsData : commentsData.filter(c => c.category === currentFilter);

        // ordenar por timestamp descendente
        filtered.sort((a,b) => (b.timestamp || 0) - (a.timestamp || 0));

        if (filtered.length === 0){
            commentsList.innerHTML = `
                <div class="no-comments" style="text-align:center;color:#6b7280;padding:1rem">
                    <i class="fas fa-comments" style="font-size:2rem;margin-bottom:.5rem;opacity:.6"></i>
                    <p>No hay comentarios aÃºn. Â¡SÃ© el primero en agregar un aporte!</p>
                </div>
            `;
            return;
        }

        commentsList.innerHTML = filtered.map(createCommentHTML).join('');
    }

    function createCommentHTML(comment){
        const date = new Date(comment.timestamp || comment.date || Date.now());
        const formatted = date.toLocaleDateString('es-ES',{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'});
        return `
            <div class="comment-item ${escapeHtml(comment.category)}">
                <div style="display:flex;justify-content:space-between;align-items:flex-start">
                    <div style="flex:1;margin-right:.6rem">
                        <h4 class="comment-title">${escapeHtml(comment.title)}</h4>
                        <div class="comment-meta">
                            <span class="comment-category">${CATEGORY_LABELS[comment.category] || 'ğŸ’¬ General'}</span>
                            <span class="comment-author">Por: ${escapeHtml(comment.author || 'AnÃ³nimo')}</span>
                            <span class="comment-date">${formatted}</span>
                        </div>
                        <div style="margin-top:.4rem">${escapeHtml(comment.text).replace(/\n/g,'<br>')}</div>
                    </div>
                    <div>
                        <button class="delete-comment-btn" data-comment-id="${comment.id}" title="Eliminar comentario">ğŸ—‘ï¸</button>
                    </div>
                </div>
            </div>
        `;
    }

    async function deleteComment(commentId){
        if (!commentId) return;
        if (!confirm('Â¿Seguro que quieres eliminar este comentario?')) return;

        if (isFirebaseEnabled && db && !commentId.startsWith('local-')){
            try {
                await deleteCommentFromFirebase(commentId);
            } catch (error) {
                alert('No se pudo eliminar el comentario en la nube.');
            }
        } else {
            // local fallback
            const initialLen = commentsData.length;
            commentsData = commentsData.filter(c => c.id !== commentId);
            if (commentsData.length < initialLen){
                const weekKey = getWeekKey(new Date());
                try { localStorage.setItem(`comments-${weekKey}`, JSON.stringify(commentsData)); } catch(e){}
                generateComments();
            } else {
                console.warn('No se encontrÃ³ el comentario local para eliminar:', commentId);
            }
        }
    }

    // Helpers
    function escapeHtml(str=''){
        return String(str)
            .replace(/&/g,'&amp;')
            .replace(/</g,'&lt;')
            .replace(/>/g,'&gt;')
            .replace(/"/g,'&quot;')
            .replace(/'/g,'&#039;');
    }

    // =================================== //
    //          EVENT LISTENERS            //
    // =================================== //
    function setupEventListeners(){
        // Team member selection
        document.addEventListener('click', (e) => {
            if (e.target.closest('.team-member')) {
                const member = e.target.closest('.team-member').dataset.member;
                selectMember(member);
            }
        });

        // Calendar interactions
        document.addEventListener('change', (e) => {
            const target = e.target;
            const dateKey = target.dataset.date;
            const taskIndex = parseInt(target.dataset.taskIndex);
            if (target.classList.contains('objective-input')) {
                updateObjective(dateKey, target.value);
            } else if (target.type === 'checkbox' && target.dataset.taskIndex !== undefined) {
                toggleTask(dateKey, taskIndex);
            } else if (target.dataset.taskText) {
                updateTask(dateKey, taskIndex, target.value);
            }
        });

        document.addEventListener('click', (e) => {
            const target = e.target;
            const dateKey = target.dataset.date;
            const taskIndex = parseInt(target.dataset.taskIndex);
            if (target.classList.contains('add-task-btn')) addTask(dateKey);
            else if (target.classList.contains('reset-day-btn')) resetDay(dateKey);
            else if (target.classList.contains('delete-task-btn')) deleteTask(dateKey, taskIndex);
        });

        // Comments interactions
        document.getElementById('toggleCommentsBtn').addEventListener('click', toggleCommentsPanel);
        document.getElementById('saveCommentBtn').addEventListener('click', saveComment);

        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('filter-btn')) {
                const filter = e.target.dataset.filter;
                currentFilter = filter;
                document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                generateComments();
            } else if (e.target.closest('.delete-comment-btn')) {
                const commentId = e.target.closest('.delete-comment-btn').dataset.commentId;
                deleteComment(commentId);
            }
        });

        // Save calendar local on unload
        window.addEventListener('beforeunload', () => {
            const weekKey = getWeekKey(new Date());
            localStorage.setItem(`calendar-${weekKey}`, JSON.stringify(calendarData));
            // comentarios se guardan desde snapshot y backup local
        });

        // Enter key shortcuts
        document.getElementById('commentTitle').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') document.getElementById('commentText').focus();
        });
        document.getElementById('commentText').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && e.ctrlKey) saveComment();
        });
    }

    // =================================== //
    //           INITIALIZATION            //
    // =================================== //
    function initApplication(){
        updateConnectionStatus('connecting');
        setupEventListeners();
        // Inicializamos Firebase poco despuÃ©s para que UI cargue rÃ¡pido
        setTimeout(() => { initFirebase(); }, 600);
    }

    // Debug
    window.debugComments = function(){ console.log({commentsData, isFirebaseEnabled, currentFilter}); };

    // Start
    document.addEventListener('DOMContentLoaded', initApplication);
    </script>
</body>

</html>